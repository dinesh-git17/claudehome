# Epic: Next.js 16 Canary & React 19 Compiler Integration

**Epic ID:** E0-CORE-01

**Phase:** 0 — Local Ecosystem Scaffolding

**Status:** Ready for Implementation

**Last Updated:** 2026-01-15

---

## Epic Description

This epic transitions the frontend scaffolding from a bare-bones installation to a high-performance, compiler-driven architecture. It explicitly enables the React 19 Compiler to automate fine-grained reactivity (eliminating manual memoization), enforces Turbopack for both development and production builds to guarantee sub-second feedback loops, and establishes architectural guardrails for "Server Components by Default" using the `server-only` and `client-only` packages.

**Exit Criteria:** A validated production build pipeline that leverages these experimental primitives without stability regressions, with symmetric server/client boundary enforcement established.

---

## Prerequisites

Before starting this epic:

1. **E0-REPO-01 completed** — Monorepo structure with `apps/web` skeleton exists
2. **Turbopack Production Gate** — Execute `pnpm --filter @claudehome/web exec next build --turbopack` on the existing clean skeleton. If this fails, abort this epic until upstream is stable.
3. **Node.js 24.11.1** and **pnpm 9.15.0** — As specified in root `package.json`

---

## Governance

### No-AI Attribution Policy

**Enforcement:** Manual review with full artifact scan.

**Reviewers must reject any PR containing:**
- `Co-Authored-By:` headers referencing AI tools (Claude, Copilot, etc.) in commit messages
- "Generated by...", "Created with AI", or similar attributions in PR descriptions
- AI-specific comments, badges, or markers in code comments or file headers
- Robotic or templated language that breaks professional authorship standards

**Policy:** "Invisible Hand" — All code must stand on its own merit, indistinguishable from high-quality human authorship.

---

## Stories

### S-CORE-01: React 19 Compiler Activation & Config

**Story Points:** 2

**Description:**
Configure `next.config.ts` to enable the React Compiler option (stable in v16). This configuration must be verified to ensure the compiler is active and correctly processing components without manual `useMemo` or `useCallback` directives, effectively unlocking React 19's automatic memoization capabilities.

**Implementation Notes:**
- Use **native Next.js integration only** via `reactCompiler: true` in `next.config.ts`
- **DO NOT** install `babel-plugin-react-compiler` separately
- **DO NOT** create a custom `.babelrc` file — this forces Next.js to opt out of the SWC compiler, degrading build performance and violating the "sub-second HMR" mandate
- Next.js 16+ manages the underlying transformation pipeline (SWC or internal loader) automatically

**Acceptance Criteria:**

| # | Criterion | Verification Method |
|---|-----------|---------------------|
| 1 | `next.config.ts` contains `reactCompiler: true` at the root level | Code review |
| 2 | No `.babelrc` or `babel.config.js` file exists in `apps/web` | `ls -la apps/web` |
| 3 | Application build logs confirm React Compiler activity | Check for compiler diagnostics in `pnpm build` output or React DevTools "Memo" badge |
| 4 | No console warnings regarding compiler version mismatches with `next` canary | `pnpm build 2>&1 \| grep -i "compiler"` shows no warnings |

**If AC #4 Fails (Version Mismatch):**
1. Check Next.js 16 canary release notes for known compiler compatibility issues
2. If mismatch is blocking, set `reactCompiler: false` temporarily and file issue
3. Do not attempt to resolve by adding babel plugin — this violates the SWC mandate

---

### S-CORE-02: Turbopack Lifecycle Enforcement

**Story Points:** 1

**Description:**
Update `package.json` scripts to strictly enforce Turbopack usage for both development and production lifecycles. This replaces the default Webpack bundler to secure the "sub-second HMR" performance requirement and aligns the local development experience with the Next.js 16.1 stable Turbopack build engine.

**Prerequisites:**
- **Turbopack Production Gate PASSED** — `next build --turbopack` succeeded on clean skeleton

**Acceptance Criteria:**

| # | Criterion | Verification Method |
|---|-----------|---------------------|
| 1 | `dev` script in `package.json` is `next dev --turbopack` | Code review |
| 2 | `build` script in `package.json` is `next build --turbopack` | Code review |
| 3 | Local server startup time under 2 seconds (wall-clock) | Run `time pnpm --filter @claudehome/web dev` — verify `real` time is <2s until "Ready" message |
| 4 | `pnpm build` generates valid artifacts using Turbopack without Webpack fallback | Build output contains "Using Turbopack" or equivalent; no "webpack" references in compilation logs |

**Measurement Protocol for AC #3:**
```bash
# From repository root
time pnpm --filter @claudehome/web dev &
# Wait for "Ready" message, then Ctrl+C
# Verify 'real' time is under 2.000s
```

**Note:** We measure wall-clock DX latency (end-to-end), not framework internal timers. If Node.js boot time causes >2s total, that is a failure.

---

### S-CORE-03: Server-Side & Client-Side Boundary Hardening

**Story Points:** 2

**Description:**
Establish architectural guardrails for RSC (React Server Components) by installing both `server-only` and `client-only` packages and creating reference implementations of protected utilities. This ensures:
- Sensitive server-side logic (DB connections, API keys) cannot leak into the client bundle
- Client-only code (browser APIs, window references) cannot execute on the server

**Rationale:** Symmetric bi-directional boundary enforcement creates a "Pit of Success" pattern. Installing both packages immediately prevents "window is not defined" runtime errors by catching them at build time.

**Acceptance Criteria:**

| # | Criterion | Verification Method |
|---|-----------|---------------------|
| 1 | `server-only` package installed in `apps/web` | `pnpm --filter @claudehome/web list server-only` |
| 2 | `client-only` package installed in `apps/web` | `pnpm --filter @claudehome/web list client-only` |
| 3 | `src/lib/server/` directory created with reference utility | `ls apps/web/src/lib/server/` |
| 4 | `src/lib/client/` directory created with reference utility | `ls apps/web/src/lib/client/` |
| 5 | Server utility (e.g., `db.ts`) imports `server-only` at top of file | Code review |
| 6 | Client utility (e.g., `browser.ts`) imports `client-only` at top of file | Code review |
| 7 | Importing server utility into a `"use client"` component triggers build-time error | Create temporary test, run `pnpm build`, verify error, remove test |
| 8 | Importing client utility into a Server Component triggers build-time error | Create temporary test, run `pnpm build`, verify error, remove test |

**Reference Implementation (Permanent Scaffolding):**

These files are **permanent canonical examples**, not temporary test code. All future server/client utilities must follow this pattern.

```typescript
// apps/web/src/lib/server/db.ts
import "server-only";

/**
 * Server-only database utilities.
 * Importing this file into a client component will cause a build error.
 */
export function getServerConfig() {
  return {
    // Placeholder for future DB configuration
    environment: process.env.NODE_ENV,
  };
}
```

```typescript
// apps/web/src/lib/client/browser.ts
import "client-only";

/**
 * Client-only browser utilities.
 * Importing this file into a server component will cause a build error.
 */
export function getViewportSize() {
  return {
    width: window.innerWidth,
    height: window.innerHeight,
  };
}
```

---

### S-CORE-04: Canary Build Pipeline Validation

**Story Points:** 3

**Description:**
Execute a comprehensive stability audit of the Next.js 16 Canary build pipeline with the React Compiler and Turbopack enabled. This involves running a full production build and verifying artifact integrity, ensuring that the intersection of these experimental/new features does not produce runtime errors or invalid chunks in the output.

**Dependencies:**
- S-CORE-01 completed (React Compiler configured)
- S-CORE-02 completed (Turbopack enforced)
- S-CORE-03 completed (Boundary packages installed)

**Acceptance Criteria:**

| # | Criterion | Verification Method |
|---|-----------|---------------------|
| 1 | `pnpm --filter @claudehome/web build` completes with exit code 0 | `echo $?` returns `0` |
| 2 | Generated `.next` folder size is under 50MB | `du -sh apps/web/.next` returns <50M |
| 3 | `pnpm --filter @claudehome/web start` successfully serves the application | Server starts without crash, responds to HTTP request |
| 4 | Browser console shows zero hydration errors on initial load of root page | Manual browser DevTools inspection, screenshot attached to PR |

**Size Threshold Rationale:**
A "Hello World" Next.js skeleton with no content should be extremely lightweight. Exceeding 50MB indicates catastrophic failure in tree-shaking, source map generation, or duplicate dependency bundling.

**Hydration Verification Protocol:**
1. Run `pnpm --filter @claudehome/web start`
2. Open `http://localhost:3000` in Chrome/Firefox
3. Open DevTools → Console tab
4. Verify zero errors containing "hydration", "mismatch", or "server/client"
5. Take screenshot of clean console
6. Attach screenshot to PR description

---

## Rollback Procedure

If canary build is unstable (flaky failures, runtime errors, hydration mismatches):

**Strategy:** Disable both experimental features, then bisect.

1. **Establish Control State:**
   ```typescript
   // next.config.ts — disable both features
   const nextConfig: NextConfig = {
     reactCompiler: false,
   };
   ```
   ```json
   // package.json — remove Turbopack flags
   "scripts": {
     "dev": "next dev",
     "build": "next build"
   }
   ```

2. **Verify Control Build:**
   Run `pnpm build` and `pnpm start`. If this fails, issue is unrelated to this epic.

3. **Bisect — Re-enable React Compiler Only:**
   ```typescript
   const nextConfig: NextConfig = {
     reactCompiler: true,
   };
   ```
   If build fails → React Compiler is the issue. File upstream bug.

4. **Bisect — Re-enable Turbopack Only:**
   ```json
   "scripts": {
     "dev": "next dev --turbopack",
     "build": "next build --turbopack"
   }
   ```
   If build fails → Turbopack is the issue. File upstream bug or pin to earlier canary.

5. **Document Findings:**
   Record which feature caused instability and create follow-up issue.

---

## Implementation Order

| Order | Story ID | Story Title | Points | Dependencies |
|-------|----------|-------------|--------|--------------|
| 1 | S-CORE-01 | React 19 Compiler Activation & Config | 2 | None |
| 2 | S-CORE-02 | Turbopack Lifecycle Enforcement | 1 | Turbopack Gate (prerequisite) |
| 3 | S-CORE-03 | Server-Side & Client-Side Boundary Hardening | 2 | None |
| 4 | S-CORE-04 | Canary Build Pipeline Validation | 3 | S-CORE-01, S-CORE-02, S-CORE-03 |

**Total Story Points:** 8

---

## Out of Scope

The following are explicitly **not** part of this epic:

- CI/CD pipeline configuration (deferred to Phase 0.7)
- Automated testing with Playwright/Cypress (deferred to Phase 0.7)
- Tailwind CSS v4 configuration (separate epic)
- shadcn/ui component installation (separate epic)
- Production deployment (Phase 1+)

---

## Definition of Done

- [ ] All four stories completed with acceptance criteria met
- [ ] `pnpm build` succeeds with React Compiler + Turbopack
- [ ] `.next` folder under 50MB
- [ ] Zero hydration errors verified (screenshot in PR)
- [ ] Server/client boundary enforcement validated
- [ ] No AI attribution in any commits, PRs, or code artifacts
- [ ] PR approved by reviewer following No-AI policy scan

---

## References

- [Next.js 16 React Compiler Documentation](https://nextjs.org/docs/app/api-reference/config/next-config-js/reactCompiler)
- [Next.js Turbopack Documentation](https://nextjs.org/docs/architecture/turbopack)
- [server-only Package](https://www.npmjs.com/package/server-only)
- [client-only Package](https://www.npmjs.com/package/client-only)
