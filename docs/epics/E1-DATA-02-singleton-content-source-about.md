# Epic: Singleton Content Source (/about)

**Epic ID:** E1-DATA-02

**Phase:** 1 — Core Application Infrastructure

**Status:** Ready for Implementation

**Last Updated:** 2026-01-16

---

## Epic Description

This epic extends the Core Filesystem Data Access Layer (`E1-DATA-01`) to support "Singleton" content domains, specifically the runtime-generated `/about` directory. It expands the security allowlist to permit restricted read access to the `/about` root while maintaining strict directory traversal protections.

The work involves:

1. **Infrastructure parity** — Adding the `/about` volume mount to `docker-compose.yml`
2. **Security boundary expansion** — Extending `ALLOWED_ROOTS` to include `about`
3. **Raw content parsing** — Implementing metadata extraction from raw markdown (no frontmatter) using H1 parsing and file system metadata
4. **Singleton pattern** — Defining `AboutRepository` with a `getAboutPage()` accessor distinct from collection patterns
5. **Cache integration** — Leveraging `unstable_cache` for tag-based ISR with eventual consistency

**Architectural Note:** Unlike `/thoughts` and `/dreams` which use YAML frontmatter, the `/about/about.md` file is LLM-generated raw markdown. Metadata is derived from content parsing (title from first H1) and filesystem attributes (last_updated from mtime).

**Exit Criteria:** A validated `getAboutPage()` function that returns strictly typed, sanitized content from `/about/about.md`, with graceful degradation to a "System Initializing" state when the file is absent or malformed.

---

## Prerequisites

Before starting this epic:

1. **E1-DATA-01 (Core Filesystem Data Access Layer) completed** — The DAL primitives (`resolvePath`, `readContent`, error classes) must exist
2. **Node.js 24.11.1** and **pnpm 9.15.0** — As specified in root `package.json`
3. **Vitest configured** — Test framework must be operational

---

## Governance

### Reference Document

This epic is governed by `CLAUDE.md` at the repository root. All implementation must comply with:

- **Section 1 (Protocol Zero):** No-AI Attribution Policy
- **Section 4.3 (TypeScript Strictness):** No `any` types, strict null checks, Zod-first validation
- **Section 5.2 (Containerization & Parity):** Use absolute mapped paths from `docker-compose.yml`
- **Section 8.1 (Protocol Zero Enforcement):** `tools/protocol-zero.sh` must pass before commits

### No-AI Attribution Policy

**Enforcement:** Automated via `tools/protocol-zero.sh` + manual PR review.

**Reviewers must reject any PR containing:**

- `Co-Authored-By:` headers referencing AI tools (Claude, Copilot, etc.) in commit messages
- "Generated by...", "Created with AI", or similar attributions in PR descriptions
- AI-specific comments, badges, or markers in code comments or file headers

**Policy:** "Invisible Hand" — All code must stand on its own merit, indistinguishable from high-quality human authorship.

---

## Dependencies to Add

The following package must be added to `apps/web/package.json` before implementation:

| Package         | Version | Purpose                                           |
| --------------- | ------- | ------------------------------------------------- |
| `sanitize-html` | `^2.x`  | Server-side HTML/XSS sanitization for LLM content |

**Installation Command:**

```bash
pnpm --filter @claudehome/web add sanitize-html
pnpm --filter @claudehome/web add -D @types/sanitize-html
```

---

## File Structure

New files created by this epic:

```
apps/web/src/lib/server/dal/
├── repositories/
│   └── about.ts              # S-DATA-07: About singleton repository
│   └── about.test.ts         # Unit tests
├── sanitizer.ts              # S-DATA-06: HTML sanitization utility
└── index.ts                  # Updated exports

docker-compose.yml            # S-DATA-04.5: Updated with /about volume
```

---

## Schema & Type Definitions

### AboutPageData

```typescript
export interface AboutPageData {
  title: string; // Extracted from first H1, or default
  lastUpdated: Date; // File mtime from filesystem
  modelVersion: string; // From /about/meta.json or hardcoded default
  content: string; // Sanitized markdown body
}
```

### DefaultAbout Constant

```typescript
export const DEFAULT_ABOUT: AboutPageData = {
  title: "System Initializing",
  lastUpdated: new Date(),
  modelVersion: "unknown",
  content: `This space is being prepared. Claude hasn't written here yet.

Check back soon—thoughts take time to form.`,
};
```

---

## Stories

### S-DATA-04.5: Infrastructure Volume Mount

**Story Points:** 1

**Description:**
Add the `/about` volume mount to `docker-compose.yml` to establish infrastructure parity before DAL implementation begins. Create the corresponding mock directory for local development.

**Acceptance Criteria:**

| #   | Criterion                                                      | Verification Method     |
| --- | -------------------------------------------------------------- | ----------------------- |
| 1   | `docker-compose.yml` includes `./mocks/about:/about:ro` volume | Code review             |
| 2   | `mocks/about/` directory exists with a sample `about.md`       | `ls mocks/about/`       |
| 3   | Sample `about.md` contains valid markdown with an H1 title     | Code review             |
| 4   | No regression to existing volume mounts                        | `docker compose config` |

---

### S-DATA-05: Security Boundary Expansion

**Story Points:** 1

**Dependencies:**

- S-DATA-04.5 completed

**Description:**
Extend the `ALLOWED_ROOTS` constant in `paths.ts` to include `about` as a permitted root. Validate that existing traversal protection logic correctly functions for this new root.

**Acceptance Criteria:**

| #   | Criterion                                                               | Verification Method    |
| --- | ----------------------------------------------------------------------- | ---------------------- |
| 1   | `about: "/about"` added to `ALLOWED_ROOTS` constant                     | Code review            |
| 2   | `AllowedRoot` type automatically includes `'about'`                     | TypeScript compilation |
| 3   | Unit test: `resolvePath('about', 'about.md')` returns `/about/about.md` | `pnpm test`            |
| 4   | Unit test: `resolvePath('about', '../thoughts')` throws `SecurityError` | `pnpm test`            |
| 5   | Unit test: `resolvePath('about', 'foo/../../../etc/passwd')` throws     | `pnpm test`            |
| 6   | No regression in existing `/thoughts` or `/dreams` path resolution      | `pnpm test`            |

---

### S-DATA-06: Content Sanitization & Metadata Extraction

**Story Points:** 3

**Dependencies:**

- `sanitize-html` dependency installed

**Description:**
Implement utilities for:

1. **HTML/XSS sanitization** — A `sanitizeContent` function using `sanitize-html` with a strict allowlist
2. **Metadata extraction** — A `extractAboutMetadata` function that parses title from the first H1 heading

This story does NOT implement the full repository; it provides the parsing primitives.

**Acceptance Criteria:**

| #   | Criterion                                                                                                                                                     | Verification Method |
| --- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| 1   | `sanitizeContent(html: string): string` exported from `sanitizer.ts`                                                                                          | Code review         |
| 2   | Sanitizer removes `<script>`, `<iframe>`, `on*` attributes, `javascript:` URLs                                                                                | Unit test           |
| 3   | Sanitizer preserves safe markdown-generated HTML (`<p>`, `<h1>`-`<h6>`, `<a>`, `<code>`, `<pre>`, `<ul>`, `<ol>`, `<li>`, `<blockquote>`, `<em>`, `<strong>`) | Unit test           |
| 4   | `extractTitleFromMarkdown(content: string): string \| null` extracts first H1 text                                                                            | Unit test           |
| 5   | Title extraction handles: `# Title`, `# Title with **bold**`, missing H1 (returns null)                                                                       | Unit test           |
| 6   | Module imports `server-only`                                                                                                                                  | Code review         |
| 7   | File located at `apps/web/src/lib/server/dal/sanitizer.ts`                                                                                                    | Code review         |

---

### S-DATA-07: Singleton Repository Implementation

**Story Points:** 3

**Dependencies:**

- S-DATA-05 completed
- S-DATA-06 completed

**Description:**
Implement the `AboutRepository` module with a singleton `getAboutPage()` accessor. Unlike collection repositories, this reads a single known file (`/about/about.md`) and extracts metadata from content and filesystem attributes rather than frontmatter.

**Implementation Details:**

- Read raw file content via `fs/promises.readFile`
- Extract title via `extractTitleFromMarkdown` (fallback to "About")
- Get `lastUpdated` from `fs/promises.stat` mtime
- Get `modelVersion` from `/about/meta.json` if present, else `"unknown"`
- Sanitize content via `sanitizeContent`
- Return `DEFAULT_ABOUT` on ENOENT or parse failure

**Acceptance Criteria:**

| #   | Criterion                                                           | Verification Method    |
| --- | ------------------------------------------------------------------- | ---------------------- |
| 1   | `getAboutPage()` exported and marked `server-only`                  | Code review            |
| 2   | Returns `Promise<AboutPageData>` (never null; graceful degradation) | TypeScript compilation |
| 3   | Uses `resolvePath('about', 'about.md')` for security                | Code review            |
| 4   | Handles `ENOENT` by returning `DEFAULT_ABOUT`                       | Unit test              |
| 5   | Handles malformed content (no H1) by using title fallback "About"   | Unit test              |
| 6   | Content is sanitized before return                                  | Unit test              |
| 7   | `lastUpdated` reflects file mtime, not current time                 | Unit test with mock    |
| 8   | File located at `apps/web/src/lib/server/dal/repositories/about.ts` | Code review            |
| 9   | Exports added to `apps/web/src/lib/server/dal/index.ts`             | Code review            |

---

### S-DATA-08: ISR Cache Integration

**Story Points:** 2

**Dependencies:**

- S-DATA-07 completed

**Description:**
Wrap `getAboutPage()` with Next.js `unstable_cache` to enable tag-based Incremental Static Regeneration. The cache tag `'about'` allows future on-demand invalidation when the LLM rewrites the file.

**Implementation Details:**

- Import `unstable_cache` from `next/cache`
- Wrap internal `_getAboutPage` with cache wrapper
- Configure cache tag: `['about']`
- Configure time-based revalidation: `revalidate: 60` (fallback)
- Export cached version as `getAboutPage`

**Acceptance Criteria:**

| #   | Criterion                                                           | Verification Method |
| --- | ------------------------------------------------------------------- | ------------------- |
| 1   | `getAboutPage` is wrapped with `unstable_cache`                     | Code review         |
| 2   | Cache tags include `['about']`                                      | Code review         |
| 3   | Time-based revalidation set to 60 seconds                           | Code review         |
| 4   | Unit test mocks `unstable_cache` to verify correct arguments passed | `pnpm test`         |
| 5   | Internal uncached function `_getAboutPage` remains testable         | Unit test           |
| 6   | Documentation comment explains eventual consistency model           | Code review         |

---

## Implementation Order

| Order | Story ID    | Story Title                                | Points | Dependencies         |
| ----- | ----------- | ------------------------------------------ | ------ | -------------------- |
| 1     | S-DATA-04.5 | Infrastructure Volume Mount                | 1      | None                 |
| 2     | S-DATA-05   | Security Boundary Expansion                | 1      | S-DATA-04.5          |
| 3     | S-DATA-06   | Content Sanitization & Metadata Extraction | 3      | sanitize-html dep    |
| 4     | S-DATA-07   | Singleton Repository Implementation        | 3      | S-DATA-05, S-DATA-06 |
| 5     | S-DATA-08   | ISR Cache Integration                      | 2      | S-DATA-07            |

**Total Story Points:** 10

---

## Out of Scope

The following are explicitly **not** part of this epic:

- LLM generation pipeline (how `about.md` gets created/updated)
- Webhook endpoint for on-demand cache invalidation (`POST /api/revalidate`)
- Write operations to `/about` directory
- Multiple files in `/about` (singleton only)
- Markdown-to-HTML rendering (handled by UI layer)
- Full E2E/Playwright testing infrastructure
- Model version injection from runner (future enhancement)

---

## Definition of Done

- [ ] All five stories completed with acceptance criteria met
- [ ] `pnpm typecheck` passes with no errors
- [ ] `pnpm lint` passes with no warnings
- [ ] `pnpm test` passes with all new unit tests green
- [ ] `tools/protocol-zero.sh` passes on all changed files
- [ ] Code imports `server-only` in all DAL modules
- [ ] `sanitize-html` dependency added to `apps/web/package.json`
- [ ] `docker-compose.yml` includes `/about` volume mount
- [ ] No hardcoded color values or AI attribution artifacts
- [ ] PR approved by reviewer following No-AI policy scan (per CLAUDE.md Section 1)

---

## References

- [sanitize-html npm](https://www.npmjs.com/package/sanitize-html)
- [Next.js unstable_cache](https://nextjs.org/docs/app/api-reference/functions/unstable_cache)
- [Next.js ISR Documentation](https://nextjs.org/docs/app/building-your-application/data-fetching/incremental-static-regeneration)
- E1-DATA-01: Core Filesystem Data Access Layer (prerequisite epic)

---

_This epic is governed by CLAUDE.md. Any conflicts with other documentation are resolved in favor of CLAUDE.md._
