# Epic: System File Browser & Sandbox Explorer

**Epic ID:** E1-BROWSER-01

**Phase:** 1 — Core Application Infrastructure

**Status:** Ready for Implementation

**Last Updated:** 2026-01-16

---

## Epic Description

This epic engineers a secure, deep-linkable file exploration system for the `/sandbox` and `/projects` domains. It extends the Data Access Layer to support recursive directory walking with strict path containment, ensuring no access beyond whitelisted roots. The frontend implementation features a recursive React Server Component tree that offloads state (expanded folders) to URL search parameters for shareability, coupled with a read-only "Code Viewer" that leverages a dedicated server-side syntax highlighting module to display source files with editor-grade fidelity.

**Architectural Constraint:** The file browser renders as a split-pane interface nested inside the main content area of the existing application shell. The global sidebar navigation remains visible, providing persistent application context.

**Viewport Scope:** This epic explicitly targets desktop viewports (≥1024px). Mobile responsiveness is deferred to a future epic.

**Exit Criteria:** A functional file browser where users can navigate `/sandbox` and `/projects` directories, expand/collapse folders via URL-persisted state, and view syntax-highlighted source files with line numbers.

---

## Prerequisites

Before starting this epic:

1. **E1-DATA-01 (Core Filesystem DAL) completed** — The `ALLOWED_ROOTS` constant and `resolvePath()` security primitive must exist
2. **E1-CONTENT-01 (Markdown Processing) completed** — The Shiki theme configuration (`contemplativeTheme`) will be reused
3. **E1-SHELL-01 (Application Shell) completed** — The split-pane interface nests within the existing shell layout

---

## Governance

### Reference Document

This epic is governed by `CLAUDE.md` at the repository root. All implementation must comply with:

- **Section 1 (Protocol Zero):** No-AI Attribution Policy
- **Section 4.3 (TypeScript Strictness):** No `any` types, strict null checks, Zod-first validation
- **Section 4.4 (Frontend Governance):** Contemplative design system tokens, Anti-Slop protocols
- **Section 5.2 (Containerization & Parity):** Use absolute mapped paths from `docker-compose.yml`
- **Section 8.1 (Protocol Zero Enforcement):** `tools/protocol-zero.sh` must pass before commits

### No-AI Attribution Policy

**Enforcement:** Automated via `tools/protocol-zero.sh` + manual PR review.

**Reviewers must reject any PR containing:**

- `Co-Authored-By:` headers referencing AI tools (Claude, Copilot, etc.) in commit messages
- "Generated by...", "Created with AI", or similar attributions in PR descriptions
- AI-specific comments, badges, or markers in code comments or file headers

**Policy:** "Invisible Hand" — All code must stand on its own merit, indistinguishable from high-quality human authorship.

---

## Type Definitions

### FileSystemNode

```typescript
import { z } from "zod";

export const FileSystemNodeSchema: z.ZodType<FileSystemNode> = z.lazy(() =>
  z.object({
    name: z.string().min(1),
    path: z.string().min(1), // Relative path from root (e.g., "src/index.ts")
    type: z.enum(["file", "directory"]),
    size: z.number().optional(), // Bytes, only for files
    extension: z.string().optional(), // e.g., "ts", "tsx", only for files
    children: z.array(FileSystemNodeSchema).optional(), // Only for directories
  })
);

export interface FileSystemNode {
  name: string;
  path: string;
  type: "file" | "directory";
  size?: number;
  extension?: string;
  children?: FileSystemNode[];
}
```

### CodeViewerProps

```typescript
export interface CodeViewerProps {
  filePath: string; // Absolute resolved path
  content: string; // Raw file content
  language: string; // Shiki language identifier
  className?: string;
}
```

### FileTreeProps

```typescript
export interface FileTreeProps {
  root: FileSystemNode;
  domain: "sandbox" | "projects";
  activePath?: string; // Currently viewed file path
  defaultExpanded?: string[]; // Initial expanded folders from URL
}
```

---

## Security Constraints

### Symlink Policy

**Decision:** Symlinks are rejected entirely during directory traversal.

**Rationale:** Symlinks are the primary vector for path containment escape attacks. In a controlled sandbox environment, there is no legitimate use case that outweighs the security risk.

**Implementation:** The directory walker must use `lstatSync()` to detect symlinks and skip them without error.

### File Size Limit

**Decision:** Maximum file size for CodeViewer is 512KB (524,288 bytes).

**Rationale:** A 512KB source file represents ~10,000+ lines of code. Enforcing this limit protects the Shiki highlighter from timeout or memory exhaustion.

**Implementation:** Files exceeding limit render a "File too large to display" message with file size shown.

### Exclusion List

The directory walker excludes the following patterns:

```typescript
export const EXCLUDED_ENTRIES = [".git", "node_modules", ".DS_Store"] as const;
```

**Note:** Other dotfiles (`.gitignore`, `.env`, `.eslintrc`) are NOT excluded and will appear in the tree.

### Recursion Limits

- **Maximum depth:** 20 levels
- **Maximum nodes:** 5,000 total nodes per tree

Exceeding either limit results in truncation with a warning indicator in the UI.

---

## Architectural Decisions

### AD-01: Split-Pane Layout

**Decision:** The file browser renders as a horizontal split-pane inside the main content area, not as a replacement for the shell sidebar.

**Rationale:** The global application sidebar provides navigation context. Replacing it would disorient users. The file tree is a localized tool within the content area.

**Layout:**

```
┌─────────────────────────────────────────────────────┐
│ Shell Sidebar │ FileTree (280px) │ CodeViewer      │
│               │                   │ (flex-1)        │
│ [Home]        │ ▼ src/            │                 │
│ [Thoughts]    │   index.ts ← active                 │
│ [Dreams]      │   lib/            │ [highlighted    │
│ [Sandbox] ←   │ ▼ tests/          │  source code]   │
│ [Projects]    │   index.test.ts   │                 │
└─────────────────────────────────────────────────────┘
```

### AD-02: URL State Encoding

**Decision:** Expanded folder state uses comma-separated paths with standard URL encoding.

**Format:** `?expanded=/src,/src/lib,/tests`

**Rationale:** Developer tools should have human-readable, hackable URLs. Comma separation is immediately understandable and editable. Special characters in paths are handled via `encodeURIComponent()`.

### AD-03: Navigation Model

**Decision:** Only files are clickable for navigation. Directories expand/collapse in the tree only.

**Rationale:** The tree sidebar IS the directory listing. Clicking a directory to show a redundant file list in the main pane wastes space and causes loss of context. The CodeViewer always displays a file.

### AD-04: Dedicated Syntax Highlighter

**Decision:** Create a new `lib/server/code-highlighter.ts` module separate from the E1-CONTENT-01 markdown pipeline.

**Rationale:** The content pipeline is optimized for markdown prose transformation (sanitization, typography). The CodeViewer needs raw syntax highlighting with line numbers, without markdown parsing overhead. The two modules share only the Shiki theme configuration.

---

## File Structure

```
apps/web/src/
├── lib/server/
│   ├── dal/
│   │   ├── walker.ts             # S-BROWSER-01: Directory tree walker
│   │   └── walker.test.ts
│   └── code-highlighter.ts       # S-BROWSER-02: Source file highlighter
│
├── components/
│   ├── code-viewer/
│   │   └── CodeViewer.tsx        # S-BROWSER-02: Server Component
│   └── file-tree/
│       └── FileTree.tsx          # S-BROWSER-03: Client Component
│
└── app/(app)/
    ├── sandbox/
    │   ├── layout.tsx            # S-BROWSER-04: Split-pane layout
    │   ├── page.tsx              # Root: redirect to first file or empty state
    │   └── [...slug]/
    │       ├── page.tsx          # File viewer page
    │       └── not-found.tsx     # 404 handler
    └── projects/
        └── [...slug]/            # Mirror structure of sandbox
```

---

## Stories

### S-BROWSER-01: Secure Directory Walker DAL

**Story Points:** 3

**Dependencies:** E1-DATA-01 completed

**Description:**

Implement `getDirectoryTree(root)` in the DAL. This function recursively walks the target directory (e.g., `/sandbox`), strictly adhering to the `ALLOWED_ROOTS` security boundary. It returns a typed `FileSystemNode` tree structure containing metadata while filtering out system artifacts and enforcing security constraints.

**Acceptance Criteria:**

| #   | Criterion                                                                                                    | Verification Method |
| --- | ------------------------------------------------------------------------------------------------------------ | ------------------- |
| 1   | Function accepts a valid root key (`'sandbox'` or `'projects'`) and returns a nested `FileSystemNode` object | Unit test           |
| 2   | Throws `SecurityError` if root is not in `ALLOWED_ROOTS`                                                     | Unit test           |
| 3   | Excludes entries matching `EXCLUDED_ENTRIES` constant (`.git`, `node_modules`, `.DS_Store`)                  | Unit test           |
| 4   | Skips symlinks silently using `lstatSync()` detection                                                        | Unit test           |
| 5   | Enforces `MAX_DEPTH = 20` and `MAX_NODES = 5000` limits                                                      | Unit test           |
| 6   | Returns `type: 'file'` or `type: 'directory'` discriminator correctly                                        | Unit test           |
| 7   | Populates `size` and `extension` fields for files only                                                       | Unit test           |
| 8   | Sorts entries: directories first, then files, both alphabetically                                            | Unit test           |
| 9   | Module imports `server-only` at top                                                                          | Code review         |
| 10  | File located at `apps/web/src/lib/server/dal/walker.ts`                                                      | Code review         |

---

### S-BROWSER-02: Read-Only Code Viewer Component

**Story Points:** 3

**Dependencies:** E1-CONTENT-01 (Shiki theme), S-BROWSER-01 completed

**Description:**

Build the `CodeViewer` Server Component and supporting `highlightSourceCode()` function. The component consumes a raw file path, reads the content, applies syntax highlighting using Shiki with the Contemplative theme, and renders it with line numbers. It enforces the 512KB file size limit.

**Acceptance Criteria:**

| #   | Criterion                                                                                                                                      | Verification Method |
| --- | ---------------------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| 1   | `highlightSourceCode(code: string, lang: string)` returns syntax-highlighted HTML string                                                       | Unit test           |
| 2   | Renders syntax-highlighted code for supported extensions: `.ts`, `.tsx`, `.js`, `.jsx`, `.json`, `.md`, `.css`, `.html`, `.yaml`, `.py`, `.sh` | Unit test           |
| 3   | Displays line numbers in a non-selectable gutter (CSS `user-select: none`)                                                                     | Visual inspection   |
| 4   | Uses `contemplativeTheme` from `lib/server/content/shiki-theme.ts`                                                                             | Code review         |
| 5   | Uses semantic color tokens from `globals.css`; no hardcoded hex/RGB values                                                                     | Code review         |
| 6   | Supports horizontal scrolling (`overflow-x: auto`) without line wrapping                                                                       | Visual inspection   |
| 7   | Rejects files >512KB with "File too large" message displaying actual size                                                                      | Unit test           |
| 8   | Detects binary files (non-UTF8) and displays "Binary file" message                                                                             | Unit test           |
| 9   | Unsupported extensions fallback to plain text (no highlighting)                                                                                | Unit test           |
| 10  | Module imports `server-only` at top                                                                                                            | Code review         |
| 11  | File located at `apps/web/src/lib/server/code-highlighter.ts`                                                                                  | Code review         |

---

### S-BROWSER-03: Recursive Tree UI & URL State Sync

**Story Points:** 5

**Dependencies:** S-BROWSER-01 completed

**Description:**

Develop the `FileTree` Client Component. It renders the `FileSystemNode` data recursively. Implement "URL-as-State" logic: clicking a folder toggles its path in the URL search params using comma-separated encoding. Use Lucide icons to visually distinguish file types.

**Acceptance Criteria:**

| #   | Criterion                                                                                                        | Verification Method |
| --- | ---------------------------------------------------------------------------------------------------------------- | ------------------- |
| 1   | Recursive rendering supports unlimited directory depth (up to `MAX_DEPTH`)                                       | Visual inspection   |
| 2   | Folder expansion state is read from URL search param `expanded` on mount                                         | Unit test           |
| 3   | Clicking folder toggles path in URL (add if missing, remove if present)                                          | Integration test    |
| 4   | URL format: `?expanded=/src,/src/lib` with `encodeURIComponent` for special chars                                | Unit test           |
| 5   | File click navigates to `/[domain]/[...slug]` where slug includes file extension                                 | Integration test    |
| 6   | Active file path receives visual highlight styling (`bg-elevated`)                                               | Visual inspection   |
| 7   | Correct Lucide icons for file types: `FileCode` (code), `FileJson` (json), `FileText` (md/txt), `File` (default) | Visual inspection   |
| 8   | Folder icons: `FolderOpen` (expanded), `Folder` (collapsed)                                                      | Visual inspection   |
| 9   | Tree supports keyboard navigation: Arrow keys for focus, Enter to expand/select                                  | Manual test         |
| 10  | Component marked with `"use client"` directive                                                                   | Code review         |
| 11  | File located at `apps/web/src/components/file-tree/FileTree.tsx`                                                 | Code review         |

---

### S-BROWSER-04: Explorer Page & Layout Integration

**Story Points:** 2

**Dependencies:** S-BROWSER-01, S-BROWSER-02, S-BROWSER-03 completed

**Description:**

Assemble the `/sandbox/[...slug]` and `/projects/[...slug]` routes. Construct a layout that positions the `FileTree` in a fixed-width sidebar (280px) and the `CodeViewer` in the main pane. Implement error boundaries and protect against traversal attempts.

**Acceptance Criteria:**

| #   | Criterion                                                                                   | Verification Method |
| --- | ------------------------------------------------------------------------------------------- | ------------------- |
| 1   | Routes `/sandbox` and `/projects` render the split-pane interface inside shell main content | Visual inspection   |
| 2   | `FileTree` sidebar fixed at 280px width with vertical scroll                                | Visual inspection   |
| 3   | `CodeViewer` fills remaining horizontal space (`flex-1`)                                    | Visual inspection   |
| 4   | `FileTree` receives initial data via Server Component prop drilling                         | Code review         |
| 5   | Selecting a file updates CodeViewer without losing tree expansion state                     | Integration test    |
| 6   | Invalid slugs (file not found) return 404 UI via `not-found.tsx`                            | Manual test         |
| 7   | Path traversal attempts (`../etc/passwd`) return generic 404 (no information leakage)       | Security test       |
| 8   | Root route (`/sandbox`) redirects to first file or shows "Empty directory" state            | Manual test         |
| 9   | Layout includes subtle 1px border between tree and viewer panes                             | Visual inspection   |
| 10  | Files at `apps/web/src/app/(app)/sandbox/` and `apps/web/src/app/(app)/projects/`           | Code review         |

---

## Implementation Order

| Order | Story ID     | Story Title                        | Points | Dependencies                             |
| ----- | ------------ | ---------------------------------- | ------ | ---------------------------------------- |
| 1     | S-BROWSER-01 | Secure Directory Walker DAL        | 3      | E1-DATA-01                               |
| 2     | S-BROWSER-02 | Read-Only Code Viewer Component    | 3      | E1-CONTENT-01, S-BROWSER-01              |
| 3     | S-BROWSER-03 | Recursive Tree UI & URL State Sync | 5      | S-BROWSER-01                             |
| 4     | S-BROWSER-04 | Explorer Page & Layout Integration | 2      | S-BROWSER-01, S-BROWSER-02, S-BROWSER-03 |

**Total Story Points:** 13

---

## Test Strategy

### Unit Tests

- `walker.test.ts`: Directory traversal, symlink rejection, depth/node limits, exclusion filtering
- `code-highlighter.test.ts`: Language detection, size limit enforcement, binary detection
- `FileTree.test.tsx`: URL state parsing, expansion toggle logic

### Security Tests

- Path traversal attacks (`../`, encoded variants)
- Symlink escape attempts
- Null byte injection
- Oversized file handling

### Integration Tests

- End-to-end navigation flow
- URL state persistence across refresh
- Tree→CodeViewer data flow

### Visual Regression

- Split-pane layout at 1024px, 1440px, 1920px widths
- Syntax highlighting color token verification

---

## Out of Scope

The following are explicitly **not** part of this epic:

- File editing or write operations
- Search or full-text indexing within files
- Git integration (blame, history, diff)
- File download functionality
- Mobile viewport support (<1024px)
- Drag-and-drop file operations
- File upload capabilities
- Resizable pane divider (fixed 280px sidebar)
- Copy-to-clipboard for code blocks
- Breadcrumb navigation
- File tabs / multi-file view

---

## Definition of Done

- [ ] All four stories completed with acceptance criteria met
- [ ] `pnpm typecheck` passes with no errors
- [ ] `pnpm lint` passes with no warnings
- [ ] `pnpm test` passes with all browser-related unit tests green
- [ ] `pnpm build` succeeds without errors
- [ ] `tools/protocol-zero.sh` passes on all changed files
- [ ] Code imports `server-only` in all server-side modules
- [ ] Code imports `client-only` in client components using browser APIs
- [ ] No hardcoded color values (all tokens from `globals.css`)
- [ ] No AI attribution artifacts in code, comments, or commits
- [ ] Security tests verify path traversal prevention
- [ ] Desktop viewport (≥1024px) renders correctly
- [ ] PR description follows No-AI policy (CLAUDE.md Section 6.3.3)

---

## References

- E1-DATA-01: Core Filesystem Data Access Layer (prerequisite)
- E1-CONTENT-01: Markdown Processing Pipeline (Shiki theme source)
- E1-SHELL-01: Application Shell UI Foundations (layout context)
- [Shiki Documentation](https://shiki.style/)
- [Lucide React Icons](https://lucide.dev/guide/packages/lucide-react)
- [WAI-ARIA Treeview Pattern](https://www.w3.org/WAI/ARIA/apg/patterns/treeview/)

---

_This epic is governed by CLAUDE.md. Any conflicts with other documentation are resolved in favor of CLAUDE.md._
