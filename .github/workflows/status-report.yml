name: Status Report

on:
  workflow_run:
    workflows: [Quality, Delivery]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  report:
    name: Update PR Status
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });

            if (prs.length === 0) {
              console.log('No open PR found for this branch');
              return null;
            }

            return prs[0].number;

      - name: Get workflow statuses
        if: steps.pr.outputs.result != 'null'
        id: status
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = context.payload.workflow_run.head_sha;
            const workflows = ['Quality', 'Delivery'];
            const statuses = {};

            for (const workflow of workflows) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: `${workflow.toLowerCase()}.yml`,
                head_sha: headSha,
                per_page: 1
              });

              if (runs.workflow_runs.length > 0) {
                const run = runs.workflow_runs[0];
                statuses[workflow] = {
                  conclusion: run.conclusion,
                  status: run.status,
                  url: run.html_url,
                  failedJob: null
                };

                // Get failed job details if workflow failed
                if (run.conclusion === 'failure') {
                  const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });

                  const failedJob = jobs.jobs.find(j => j.conclusion === 'failure');
                  if (failedJob) {
                    statuses[workflow].failedJob = {
                      name: failedJob.name,
                      url: failedJob.html_url
                    };
                  }
                }
              } else {
                statuses[workflow] = { status: 'pending', conclusion: null };
              }
            }

            return statuses;

      - name: Build status table
        if: steps.pr.outputs.result != 'null'
        id: table
        uses: actions/github-script@v7
        with:
          script: |
            const statuses = ${{ steps.status.outputs.result }};

            const getStatusEmoji = (s) => {
              if (!s || s.status === 'pending' || s.status === 'in_progress') return '⏳ Running';
              if (s.conclusion === 'success') return '✅ Passed';
              if (s.conclusion === 'failure') return '❌ Failed';
              if (s.conclusion === 'cancelled') return '⚪ Cancelled';
              return '❓ Unknown';
            };

            const getFailurePath = (s) => {
              if (!s || s.conclusion !== 'failure') return '-';
              if (s.failedJob) return `[${s.failedJob.name}](${s.failedJob.url})`;
              return `[View logs](${s.url})`;
            };

            const table = [
              '| Workflow | Status | Failure Path |',
              '| :--- | :--- | :--- |',
              `| Quality | ${getStatusEmoji(statuses.Quality)} | ${getFailurePath(statuses.Quality)} |`,
              `| Delivery | ${getStatusEmoji(statuses.Delivery)} | ${getFailurePath(statuses.Delivery)} |`
            ].join('\n');

            core.setOutput('table', table);

      - name: Find existing comment
        if: steps.pr.outputs.result != 'null'
        id: find
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ steps.pr.outputs.result }}
          comment-author: "github-actions[bot]"
          body-includes: "<!-- status-report -->"

      - name: Create or update comment
        if: steps.pr.outputs.result != 'null'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find.outputs.comment-id }}
          issue-number: ${{ steps.pr.outputs.result }}
          edit-mode: replace
          body: |
            <!-- status-report -->
            ## CI Status Report

            ${{ steps.table.outputs.table }}

            <sub>Updated: ${{ github.event.workflow_run.updated_at }}</sub>
