name: Governance Audit

on:
  schedule:
    - cron: "0 9 * * 1" # Weekly on Monday at 9:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  audit:
    name: Repository Settings Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Audit repository settings
        id: audit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          DRIFT_DETECTED=false
          DRIFT_REPORT=""

          # Fetch repository settings directly
          SQUASH=$(gh api "repos/${REPO}" --jq '.allow_squash_merge')
          MERGE=$(gh api "repos/${REPO}" --jq '.allow_merge_commit')
          REBASE=$(gh api "repos/${REPO}" --jq '.allow_rebase_merge')
          DELETE_BRANCH=$(gh api "repos/${REPO}" --jq '.delete_branch_on_merge')
          WIKI=$(gh api "repos/${REPO}" --jq '.has_wiki')
          PROJECTS=$(gh api "repos/${REPO}" --jq '.has_projects')

          # Check squash-only merge policy
          if [[ "$SQUASH" != "true" ]]; then
            DRIFT_DETECTED=true
            DRIFT_REPORT+="- Squash merge is disabled (expected: enabled)\n"
          fi

          if [[ "$MERGE" != "false" ]]; then
            DRIFT_DETECTED=true
            DRIFT_REPORT+="- Merge commit is enabled (expected: disabled)\n"
          fi

          if [[ "$REBASE" != "false" ]]; then
            DRIFT_DETECTED=true
            DRIFT_REPORT+="- Rebase merge is enabled (expected: disabled)\n"
          fi

          # Check branch hygiene
          if [[ "$DELETE_BRANCH" != "true" ]]; then
            DRIFT_DETECTED=true
            DRIFT_REPORT+="- Auto-delete branches is disabled (expected: enabled)\n"
          fi

          # Check noise reduction
          if [[ "$WIKI" != "false" ]]; then
            DRIFT_DETECTED=true
            DRIFT_REPORT+="- Wiki is enabled (expected: disabled)\n"
          fi

          if [[ "$PROJECTS" != "false" ]]; then
            DRIFT_DETECTED=true
            DRIFT_REPORT+="- Projects is enabled (expected: disabled)\n"
          fi

          # Check ruleset exists
          RULESET_COUNT=$(gh api "repos/${REPO}/rulesets" --jq 'length')
          if [[ "$RULESET_COUNT" -eq 0 ]]; then
            DRIFT_DETECTED=true
            DRIFT_REPORT+="- No rulesets configured (expected: Production Governance ruleset)\n"
          else
            RULESET_ACTIVE=$(gh api "repos/${REPO}/rulesets" --jq '.[] | select(.name == "Production Governance" and .enforcement == "active") | .name')
            if [[ -z "$RULESET_ACTIVE" ]]; then
              DRIFT_DETECTED=true
              DRIFT_REPORT+="- Production Governance ruleset not active\n"
            fi
          fi

          # Output results
          echo "drift_detected=$DRIFT_DETECTED" >> "$GITHUB_OUTPUT"
          if [[ "$DRIFT_DETECTED" == "true" ]]; then
            {
              echo "drift_report<<EOF"
              echo -e "$DRIFT_REPORT"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Create drift issue
        if: steps.audit.outputs.drift_detected == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRIFT_REPORT: ${{ steps.audit.outputs.drift_report }}
        run: |
          gh issue create \
            --title "Governance Drift Detected" \
            --body "## Repository Configuration Drift

          The weekly governance audit detected the following configuration drift:

          ${DRIFT_REPORT}

          ## Required Action

          Review and restore repository settings to match governance requirements defined in E0-GOV-01.

          ## Audit Details

          - **Repository:** ${{ github.repository }}
          - **Run ID:** ${{ github.run_id }}
          - **Triggered:** ${{ github.event_name }}"

      - name: Audit passed
        if: steps.audit.outputs.drift_detected != 'true'
        run: echo "âœ“ All governance checks passed. No drift detected."
